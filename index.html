<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>مبنى رابطة العالم الإسلامي</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: white;
      color: black;
      margin: 0;
      padding: 20px;
      font-weight: bold;
      overflow: auto;
    }
    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-image: url('https://raw.githubusercontent.com/abdulkhaleq404/housing-system/main/logopng2.png');
      background-repeat: no-repeat;
      background-position: center center;
      background-size: 600px auto;
      opacity: 0.25;
      z-index: -2;
      pointer-events: none;
    }
    #logo2 {
      position: fixed;
      top: 10px; left: 10px;
      z-index: -1;
      opacity: 1;
    }
    h2 {
      text-align: center;
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    #main-btn, .floor-btn, #all-btn, #duplicates-btn, #tasks-btn {
      padding: 10px 18px;
      margin: 5px;
      background-color: #2f2f2f;
      border: none;
      color: white;
      cursor: pointer;
      border-radius: 5px;
      font-size: 16px;
    }
    #main-btn { font-size: 19px; background-color: #0b2545; }
    #main-btn:hover { background-color: #133b5c; }
    .floor-selection, .secondary-buttons {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }
    .floor-btn:hover, #all-btn:hover, #duplicates-btn:hover, #tasks-btn:hover {
      background-color: #3a3a3a;
    }
    #search {
      display: none;
      margin: 10px auto;
      padding: 6px 10px;
      width: 200px;
      text-align: center;
      border-radius: 5px;
      border: 1px solid #444;
      background-color: #1e1e1e;
      color: white;
    }
    #export-btn, #report-link-btn {
      display: none;
      margin: 10px auto;
      padding: 6px 12px;
      font-size: 14px;
      background-color: #0b2545;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #export-btn:hover, #report-link-btn:hover {
      background-color: #133b5c;
    }
    .stats-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      justify-items: center;
      margin-top: 20px;
    }
    .stat-box {
      background-color: #2c2c2c;
      border-radius: 8px;
      padding: 15px;
      width: 160px;
      text-align: center;
      font-size: 16px;
      color: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    .stat-number { font-size: 28px; margin-top: 10px; }
    .cards-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    .room-card {
      background-color: #2c2c2c;
      border-radius: 8px;
      width: calc(25% - 10px);
      padding: 10px;
      box-sizing: border-box;
      position: relative;
      color: white;
    }
    .room-title { font-weight: bold; text-align: center; margin-bottom: 5px; }
    .toggle-btn {
      position: absolute; top: 10px; left: 10px;
      background: none; color: white; border: none; font-size: 20px; cursor: pointer;
    }
    .occupants { display: none; margin-top: 10px; }
    .occupant {
      background-color: #333;
      padding: 5px;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .occupant input, .occupant select {
      width: 100%;
      margin-bottom: 5px;
      padding: 5px;
      border-radius: 4px;
      border: 1px solid #555;
      background-color: #2f2f2f;
      color: white;
      text-align: center;
      box-sizing: border-box;
    }
    .status-dots {
      display: flex; gap: 4px; justify-content: center; margin-bottom: 5px;
    }
    .dot {
      width: 10px; height: 10px; border-radius: 50%; background-color: green;
    }
    .dot.filled { background-color: red; }
    .occupied-count { text-align: center; margin-bottom: 5px; }
    .duplicates-container {
      display: grid;
      grid-template-columns: repeat(3,1fr);
      gap: 10px;
      margin-top: 20px;
    }
    .dup-card {
      background-color: #444;
      padding: 10px;
      border-radius: 8px;
      color: white;
      white-space: pre-wrap;
      text-align: right;
    }
    .tasks-header { text-align: center; margin-bottom: 10px; }
    .tasks-header button {
      font-size: 24px; width: 40px; height: 40px; border-radius: 50%;
      background-color: #0b2545; color: white; border: none; cursor: pointer;
    }
    .tasks-container {
      display: grid; grid-template-columns: repeat(3,minmax(200px,1fr));
      gap: 15px; margin-top: 10px; justify-items: center;
    }
    .task-card {
      background-color: #2c2c2c; color: white; padding: 15px; border-radius: 8px;
      text-align: center;
    }
    .task-card input, .task-card textarea {
      width: 100%; margin-bottom: 8px; padding: 5px; border-radius: 4px;
      border: 1px solid #555; background-color: #333; color: white;
      box-sizing: border-box;
    }
    .task-card textarea { height: 60px; resize: none; }
    .task-actions { display: flex; justify-content: space-between; }
    .task-actions button {
      flex: 1; margin: 0 5px; padding: 6px; border: none; border-radius: 4px;
      background-color: #444; color: white; cursor: pointer;
    }
    .task-actions .dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background-color: #ccc; margin-left: 6px; vertical-align: middle; }
    .task-buttons { text-align: center; margin-top: 10px; }
    .save-btn { background-color: #0b2545; color:white; padding: 6px 12px; border:none; border-radius:4px; cursor:pointer; margin:0 5px; }
    .delete-btn { background-color: #c62828; color:white; padding: 6px 12px; border:none; border-radius:4px; cursor:pointer; margin:0 5px; }
  </style>
</head>
<body>
  <div id="login-screen" style="display:flex; flex-direction:column; align-items:center; margin-top:50px;">
    <h2>تسجيل الدخول</h2>
    <input id="login-username" type="text" placeholder="Username" style="padding:8px; margin:8px 0; width:250px;"/>
    <input id="login-password" type="password" placeholder="Password" style="padding:8px; margin:8px 0; width:250px;"/>
    <button id="login-button" style="padding:8px 16px; margin:8px 0;">دخول</button>
  </div>
  <div id="app" style="display:none;">
    <div id="logo2">
      <img src="https://raw.githubusercontent.com/abdulkhaleq404/housing-system/main/logopng3.png" alt="شعار ثانوي" style="max-width:250px;height:auto;">
    </div>
    <h2>مبنى رابطة العالم الإسلامي</h2>
    <button id="main-btn">الصفحة الرئيسية</button>
    <div class="floor-selection">
      <button class="floor-btn" data-floor="1">الطابق الأول</button>
      <button class="floor-btn" data-floor="2">الطابق الثاني</button>
      <button class="floor-btn" data-floor="3">الطابق الثالث</button>
      <button class="floor-btn" data-floor="4">الطابق الرابع</button>
    </div>
    <div class="secondary-buttons">
      <button id="all-btn">الجميع</button>
      <button id="duplicates-btn">المتكررات</button>
      <button id="tasks-btn">المهام</button>
    </div>
    <input type="text" id="search" placeholder="البحث" oninput="searchRooms()">
    <button id="export-btn" onclick="exportData()">تقرير بيانات الغرف</button>
    <button id="report-link-btn" onclick="exportBuildingReport()">تقرير مبنى الرابطة</button>
    <div id="cards" class="cards-container"></div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzfomXUIag_T5wunhBe18KRYIP4LGCqU4jtnbGMxT_bYIHQkoTcxeluRs4fQ8AjPCUK/exec';
    const ADMIN_USER = 'abdulkhaleq';
    const ADMIN_PASS = 'Abdu1kha1eq#404seS1';

    let data = {};
    let tasks = [];

    async function loadData() {
      const guests = await fetch(`${API_URL}?sheet=guests`).then(r=>r.json());
      data = {};
      guests.forEach(g => {
        const key = 'room-' + g.room;
        if (!data[key]) data[key] = [];
        data[key].push({ name: g.name, phone: g.phone, rank: g.info, plate: '', grade: '' });
      });
      // Ensure at least 3 slots per room
      Object.keys(data).forEach(k => {
        while (data[k].length < 3) data[k].push({ name:'',phone:'',rank:'',plate:'',grade:'' });
      });

      // Load tasks
      tasks = await fetch(`${API_URL}?sheet=tasks`).then(r=>r.json());
    }

    document.addEventListener('DOMContentLoaded', () => {
      const loginBtn = document.getElementById('login-button');
      loginBtn.onclick = async () => {
        const u = document.getElementById('login-username').value;
        const p = document.getElementById('login-password').value;
        if (u===ADMIN_USER && p===ADMIN_PASS) {
          document.getElementById('login-screen').style.display='none';
          document.getElementById('app').style.display='block';
          setupHandlers();
          await loadData();
          loadMain();
        } else alert('اسم المستخدم أو كلمة المرور غير صحيحة');
      };
    });

    function setupHandlers() {
      document.getElementById('main-btn').onclick = async () => { await loadData(); loadMain(); };
      document.querySelectorAll('.floor-btn').forEach(b=> {
        b.onclick = async () => { await loadData(); loadFloor(Number(b.dataset.floor)); };
      });
      document.getElementById('all-btn').onclick = async () => { await loadData(); loadFloor(0); };
      document.getElementById('duplicates-btn').onclick = async () => { await loadData(); loadDuplicates(); };
      document.getElementById('tasks-btn').onclick = async () => { await loadData(); loadTasks(); };
    }

    function clearCards() { document.getElementById('cards').innerHTML = ''; }

    function loadMain() {
      clearCards();
      document.getElementById('search').style.display='none';
      document.getElementById('export-btn').style.display='none';
      document.getElementById('report-link-btn').style.display='none';
      const rooms = Object.keys(data);
      let total=0, filled=0, officers=0, enlisted=0, cars=0;
      const officerRanks=['ملازم','ملازم أول','نقيب','رائد','مقدم','عقيد','عميد','لواء'];
      rooms.forEach(r => {
        data[r].forEach(o => {
          if(o.name){ filled++; total++; 
            if(officerRanks.includes(o.rank)) officers++; else enlisted++;
            if(o.plate) cars++;
          } else total++;
        });
      });
      const stats=[
        ['السعة الإجمالية', total],
        ['الطاقة المتاحة للتسكين', total-filled],
        ['عدد الضيوف الحاليين', filled],
        ['الضباط', officers],
        ['الأفراد', enlisted],
        ['السيارات', cars]
      ];
      const container=document.getElementById('cards');
      const wrap=document.createElement('div');
      wrap.className='stats-container';
      stats.forEach(([n,v])=>{
        const box=document.createElement('div');box.className='stat-box';
        box.innerHTML=`<div>${n}</div><div class="stat-number">${v}</div>`;
        wrap.appendChild(box);
      });
      container.appendChild(wrap);
    }

    function loadFloor(floor) {
      clearCards();
      const container=document.getElementById('cards');
      document.getElementById('search').style.display=(floor===0?'block':'none');
      document.getElementById('export-btn').style.display=(floor===0?'block':'none');
      document.getElementById('report-link-btn').style.display=(floor===0?'block':'none');
      const keys=Object.keys(data).sort((a,b)=>parseInt(a.split('-')[1])-parseInt(b.split('-')[1]));
      keys.forEach(k=>{
        const fl=Number(k.split('-')[1][0]);
        if(floor===0||fl===floor) container.appendChild(createRoomCard(k, k.split('-')[1]));
      });
    }

    function createRoomCard(key, num) {
      const card=document.createElement('div');card.className='room-card';
      card.innerHTML=`<div class="room-title">غرفة | ${num}</div>
        <button class="toggle-btn">+</button>
        <div class="occupied-count"></div>
        <div class="status-dots"></div>
        <div class="occupants"></div>`;
      const occContainer=card.querySelector('.occupants');
      const toggle=card.querySelector('.toggle-btn');
      toggle.onclick=()=>{
        const show=occContainer.style.display!=='block';
        occContainer.style.display=show?'block':'none';
        toggle.textContent=show?'-':'+';
      };
      const dotsBox=card.querySelector('.status-dots');
      data[key].forEach((o,idx)=>{
        const dot=document.createElement('div');dot.className='dot'+(o.name?' filled':'');
        dotsBox.appendChild(dot);
        const div=document.createElement('div');div.className='occupant';
        div.innerHTML=`<input type="text" placeholder="الإسم" value="${o.name}" oninput="updateField('${key}',${idx},'name',this.value)">
          <input type="tel" placeholder="رقم الجوال" maxlength="10" value="${o.phone}" oninput="updateField('${key}',${idx},'phone',this.value)">
          <select onchange="updateField('${key}',${idx},'rank',this.value)">${['','جندي','جندي أول','عريف','وكيل رقيب','رقيب','رقيب أول','رئيس رقباء','ملازم','ملازم أول','نقيب','رائد','مقدم','عقيد','عميد','لواء'].map(r=>`<option value="${r}"${o.rank===r?' selected':''}>${r}</option>`).join('')}</select>
          <select onchange="updateField('${key}',${idx},'grade',this.value)">${['','1','2','3','4','5','6','7','8','9','10','11','12','13','14'].map(g=>`<option value="${g}"${o.grade==g?' selected':''}>${g}</option>`).join('')}</select>
          <input type="text" placeholder="رقم اللوحة" value="${o.plate}" oninput="updateField('${key}',${idx},'plate',this.value)">`;
        occContainer.appendChild(div);
      });
      const occCount=data[key].filter(o=>o.name).length;
      card.querySelector('.occupied-count').textContent=`${occCount} / ${data[key].length}`;
      return card;
    }

    function updateField(room,i,field,val){
      data[room][i][field]=val;
    }

    function loadDuplicates(){
      clearCards();
      const container=document.createElement('div');container.className='duplicates-container';
      const nameMap={};
      Object.keys(data).forEach(room=>{
        data[room].forEach(o=>{
          if(o.name){
            nameMap[o.name]=nameMap[o.name]||new Set();
            nameMap[o.name].add(room.replace('room-',''));
          }
        });
      });
      Object.entries(nameMap).forEach(([name,rooms])=>{
        if(rooms.size>1){
          const card=document.createElement('div');card.className='dup-card';
          card.textContent=`• تشابه في الاسم\n( ${name} )\nالغرف ( ${[...rooms].join(' - ')} )`;
          container.appendChild(card);
        }
      });
      clearCards();document.getElementById('cards').appendChild(container);
    }

    function loadTasks(){
      clearCards();
      const cards=document.getElementById('cards');
      const hdr=document.createElement('div');hdr.className='tasks-header';
      const btn=document.createElement('button');btn.textContent='+';btn.onclick=addTask;
      hdr.appendChild(btn);cards.appendChild(hdr);
      const cont=document.createElement('div');cont.className='tasks-container';cards.appendChild(cont);
      tasks.forEach((t,i)=>renderTask(t,i));
    }

    function addTask(){
      tasks.unshift({type:'',details:'',status:'pending'});
      renderAllTasks();
    }

    function renderTask(t,i){
      const cont=document.querySelector('.tasks-container');
      const card=document.createElement('div');card.className='task-card';
      card.setAttribute('data-idx',i);
      card.innerHTML=`<input type="text" placeholder="نوع المهمة" value="${t.type}" onchange="tasks[${i}].type=this.value">
        <textarea placeholder="التفاصيل" onchange="tasks[${i}].details=this.value">${t.details}</textarea>
        <div class="task-actions">
          <button onclick="setTaskStatus(${i},'pending')">تحت المعالجة <span class="dot pending"></span></button>
          <button onclick="setTaskStatus(${i},'done')">تمت المعالجة <span class="dot done"></span></button>
        </div>
        <div class="task-buttons">
          <button class="save-btn" onclick="saveTask(${i})">حفظ</button>
          <button class="delete-btn" onclick="deleteTask(${i})">حذف</button>
        </div>`;
      cont.appendChild(card);
      updateTaskStatusDisplay(card,t.status);
    }

    function updateTaskStatusDisplay(card,status){
      card.querySelector('.dot.pending').style.backgroundColor=status==='pending'?'orange':'#ccc';
      card.querySelector('.dot.done').style.backgroundColor=status==='done'?'green':'#ccc';
    }

    async function saveTask(i){
      await fetch(`${API_URL}?sheet=tasks`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(tasks[i])
      });
      await loadData(); loadTasks();
    }

    function deleteTask(i){
      tasks.splice(i,1);
      renderAllTasks();
    }

    function renderAllTasks(){const cont=document.querySelector('.tasks-container');cont.innerHTML='';tasks.forEach((t,i)=>renderTask(t,i));}

    function searchRooms(){const v=document.getElementById('search').value.toLowerCase();document.querySelectorAll('.room-card').forEach(c=>c.style.display=c.querySelector('.room-title').textContent.includes(v)?'block':'none');}

    function exportData(){/* as before or omitted */ alert('تصدير البيانات ليست مفعلة');}
    function exportBuildingReport(){alert('تقرير المبنى غير مفعّل');}
  </script>
</body>
</html>
