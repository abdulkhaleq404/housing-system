<!DOCTYPE html>
<div class="background-logo"></div>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>مـبـنى رابـطـة الـعـالـم الإسـلامـي</title>
<style>

body {
  font-family: 'Arial', sans-serif;
  background-color: white; /* تغيير اللون إلى الأبيض */
  color: white; /* تغيير لون النص إلى الأسود ليتناسب مع الخلفية البيضاء */
  margin: 0;
  padding: 20px;
  font-weight: bold;
}

/* نصوص العناوين أو الإحصائيات */
.stats-title,
.stats-number {
  color: white;
  z-index: 1;
position: relative;
}
h2 {
  text-align: center;
  font-size: 35px !important;  /* زيادة الحجم */
  font-weight: bold !important; /* جعل النص بولد */
  color: black !important;     /* لون أسود */
}
/* نصوص الغرف داخل الكروت */
.card .room-number,
.card .guest-info {
  color: white;
  z-index: 1;
position: relative;
}
h2,
.floor-btn,
#main-btn,
.stat-box,
.room-title,
.toggle-btn,
.occupant input,
.occupant select,
#search,
#export-btn {
font-weight: bold;
}
h2 {
text-align: center;
font-size: 28px;
}
.floor-selection {
display: flex;
justify-content: center;
flex-wrap: wrap;
gap: 10px;
margin: 20px 0 15px;
font-size: 18px;
z-index: 1;
position: relative;
}

.floor-btn {
  padding: 10px 18px;
  background-color: #2f2f2f; /* لون داكن أوضح */
  border: none;
  color: white;
  cursor: pointer;
  border-radius: 5px;
  font-size: 16px;
  z-index: 1;
position: relative;
}

.floor-btn:hover {
  background-color: #3a3a3a;
  z-index: 1;
position: relative;
}

#main-btn {
  font-size: 19px;
  padding: 12px 20px;
  background-color: #0b2545;
  color: white;
  opacity:1; /* ت أكيد إلغاء أي شفافية */
z-index: 1;
position: relative;
  
}
body::before {
  content: "";
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: url('https://raw.githubusercontent.com/abdulkhaleq404/housing-system/refs/heads/main/logopng2.png');
  background-repeat: no-repeat;
  background-position: center center;
  background-size: 600px auto;
  opacity: 0.25; /* شفافية 0.25 */
  z-index: -1;
  pointer-events: none;
}
#main-btn:hover {
  background-color: #133b5c;  opacity: 1; /* تأكيد إلغاء أي شفافية */
z-index: 1;
position: relative;
}

#search {
  display: none;
  margin: 0 auto 10px;
  padding: 6px 10px;
  width: 200px;
  text-align: center;
  border-radius: 5px;
  border: 1px solid #444;
  background-color: #1e1e1e;
  color: white;
  z-index: 1;
position: relative;
}

#export-btn {
  display: none;
  margin: 0 auto 20px;
  padding: 6px 12px;
  font-size: 14px;
  background-color: #0b2545;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  opacity: 1; /* تأكيد إلغاء أي شفافية */
z-index: 1;
position: relative;
}
<style>
  body {
    overflow: hidden;
  }

#export-btn:hover {
  background-color: #133b5c;
  opacity: 1; /* تأكيد إلغاء أي شفافية */
z-index: 1;
position: relative;
}

.stats-container {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 15px;
justify-items: center;
margin-top: 40px;
z-index: 1;
position: relative;
}

.stat-box {
  background-color: #2c2c2c; /* الحفاظ على اللون */
  border-radius: 8px;
  padding: 15px;
  width: 160px;
  text-align: center;
  font-size: 16px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); /* الحفاظ على الظل */
z-index: 1;
position: relative;
}

.stat-number {
font-size: 28px;
margin: 10px 0 0;
z-index: 1;
position: relative;
}
.cards-container {
display: flex;
flex-wrap: wrap;
gap: 10px;
justify-content: center;
z-index: 1;
position: relative;
}

.room-card {
  background-color: #2c2c2c; /* الحفاظ على اللون */
  border-radius: 8px;
  width: calc(25% - 10px);
  padding: 10px;
  box-sizing: border-box;
  transition: 0.3s ease;
  position: relative;
  z-index: 1;
position: relative;
}

.room-card.open .occupants {
display: block;
z-index: 1;
position: relative;
}
.room-title {
font-weight: bold;
margin-bottom: 5px;
text-align: center;
z-index: 1;
position: relative;
}
.toggle-btn {
position: absolute;
top: 10px;
left: 10px;
background: none;
color: white;
border: none;
font-size: 20px;
cursor: pointer;
z-index: 1;
position: relative;
}
.occupants {
display: none;
margin-top: 10px;
z-index: 1;
position: relative;
}

.occupant {
  margin-bottom: 10px;
  background-color: #333; /* تم تعديل اللون ليكون أغمق بقليل */
  padding: 5px;
  border-radius: 4px;
  z-index: 1;
position: relative;
}

.occupant input,
.occupant select {
  width: 100%;
  padding: 5px;
  background-color: #2f2f2f; /* لون غير شفاف قريب جدًا من السابق */
  border: 1px solid #555;
  color: white;
  text-align: center;
  box-sizing: border-box;
  margin-bottom: 5px;
  z-index: 1;
position: relative;
}

.status-dots {
display: flex;
gap: 4px;
justify-content: center;
margin-bottom: 5px;
z-index: 1;
position: relative;
}
.dot {
width: 10px;
height: 10px;
border-radius: 50%;
background-color: green;
z-index: 1;
position: relative;
}
.dot.filled {
background-color: red;
z-index: 1;
position: relative;
}
@media (max-width: 768px) {
.room-card {
width: 100%;
}
.stats-container {
grid-template-columns: repeat(1, 1fr);
}
}
<style>
  body {
    overflow: hidden;
  }

</style>
</head>
<body>
<img src="https://raw.githubusercontent.com/abdulkhaleq404/housing-system/refs/heads/main/logopng2.png" alt="شعار" style="position: fixed; top: 10px; left: 10px; max-width: 200px; height: auto; opacity: 1; z-index: -1; pointer-events: none;">
<h2>مـبـنى رابـطـة الـعـالـم الإسـلامـي</h2>

<div class="floor-selection">
<button id="main-btn" class="floor-btn" onclick="loadMain()">الـصـفـحـة الـرئـيـسـية</button>
</div>

<div class="floor-selection">
<button class="floor-btn" onclick="loadFloor(1)">الــطـــابــق الأول</button>
<button class="floor-btn" onclick="loadFloor(2)">الـطـابـق الـثــانـي</button>
<button class="floor-btn" onclick="loadFloor(3)">الـطـابـق الـثـالـث</button>
<button class="floor-btn" onclick="loadFloor(4)">الـطــابــق الـرابـع</button>
<button class="floor-btn" onclick="loadFloor(0)">الـجـمـيـع</button>
</div>

<input type="text" id="search" placeholder="البحث" oninput="searchRooms()">
<button id="export-btn" onclick="exportData()">إصـدار تـقـريـر</button>

<div id="cards" class="cards-container"></div>

<script>
const SHEET_URL = 'https://script.google.com/macros/s/AKfycbwhXcN72pLqG-CdOXMKk3Z--_feGrJYoRX67m8qzzpDy5FBQAj0YnoPn_lT_lsZLwkp/exec';

async function sendToGoogleSheet(payload) {
  try {
    const res = await fetch(SHEET_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    return await res.json();
  } catch (err) {
    console.error('Error sending to Google Sheets:', err);
  }
}

async function fetchGuests() {
  try {
    const res = await fetch(`${SHEET_URL}?action=getAll&sheet=Guests`);
    const guests = await res.json();
    data = {};
    guests.forEach(item => {
      const key = `room-${item.floor}${item.room}`;
      data[key] = data[key] || [];
      data[key].push({
        name: item.name,
        phone: item.phone,
        rank: item.rank || '',
        grade: item.grade || '',
        plate: item.plate || '',
        checkin_date: item.checkin_date,
        checkout_date: item.checkout_date,
        status: item.status
      });
    });
    saveToStorage();
    loadMain();
    loadFloor(currentFloor);
  } catch (err) {
    console.error('Error fetching Guests:', err);
  }
}

window.addEventListener('load', fetchGuests);

// بيانات التطبيق
let currentFloor = 1;
const roomCounts = {1:36,2:36,3:12,4:12};
const occupantsPerRoom = {1:3,2:3,3:16,4:16};
const ranks = {
  1: ['جندي','جندي أول','عريف','وكيل رقيب','رقيب','ملازم','ملازم أول','نقيب','رائد','مقدم','عقيد','عميد','لواء'],
  2: ['جندي','جندي أول','عريف','وكيل رقيب','رقيب','ملازم','ملازم أول','نقيب','رائد','مقدم','عقيد','عميد','لواء'],
  3: ['جندي','جندي أول','عريف','وكيل رقيب','رقيب','ملازم','ملازم أول','نقيب','رائد','مقدم','عقيد','عميد','لواء'],
  4: ['جندي','جندي أول','عريف','وكيل رقيب','رقيب','ملازم','ملازم أول','نقيب','رائد','مقدم','عقيد','عميد','لواء']
};
let data = JSON.parse(localStorage.getItem('housingData')||'{}');

function saveToStorage() {
  localStorage.setItem('housingData', JSON.stringify(data));
}

function loadMain() {
  const cards = document.getElementById('cards');
  cards.innerHTML = `
    <div class="stats-container">
      <div class="stat-box"><div>الطاقة الإجمالية</div><div class="stat-number">600</div></div>
      <div class="stat-box"><div>المتاحة</div><div class="stat-number">${600 - countGuests()}</div></div>
      <div class="stat-box"><div>الضيوف</div><div class="stat-number">${countGuests()}</div></div>
      <div class="stat-box"><div>ضباط</div><div class="stat-number">${countRanks('ضباط')}</div></div>
      <div class="stat-box"><div>أفراد</div><div class="stat-number">${countRanks('أفراد')}</div></div>
      <div class="stat-box"><div>السيارات</div><div class="stat-number">${countCars()}</div></div>
    </div>`;
  document.getElementById('search').style.display='none';
  document.getElementById('export-btn').style.display='none';
}

function countGuests() {
  return Object.values(data).flat().filter(o=>o.name).length;
}

function countRanks(type) {
  const officers = ranks[1];
  return Object.values(data).flat().filter(o=>o.rank).filter(o=> type==='ضباط'? officers.includes(o.rank): !officers.includes(o.rank)).length;
}

function countCars() {
  return Object.values(data).flat().filter(o=>o.plate).length;
}

function loadFloor(floor) {
  currentFloor = floor;
  document.getElementById('search').value='';
  const cards = document.getElementById('cards');
  cards.innerHTML='';
  const floors = floor===0? [1,2,3,4]: [floor];
  floors.forEach(f=>{
    for(let i=1;i<=roomCounts[f];i++){
      const num = `${f}${String(i).padStart(2,'0')}`;
      const key = `room-${num}`;
      if(!data[key]) data[key] = Array.from({length:occupantsPerRoom[f]}, ()=>({name:'',phone:'',rank:'',grade:'',plate:''}));
      cards.appendChild(createRoomCard(key,num,f));
    }
  });
  document.getElementById('search').style.display = floor===0?'block':'none';
  document.getElementById('export-btn').style.display = floor===0?'block':'none';
  saveToStorage();
}

function createRoomCard(key,num,floor){
  const card=document.createElement('div'); card.className='room-card'; card.id=key;
  const title=document.createElement('div'); title.className='room-title'; title.textContent=`غرفة ${num}`;
  const btn=document.createElement('button'); btn.className='toggle-btn'; btn.textContent='+';
  btn.onclick=()=>{card.classList.toggle('open'); btn.textContent = card.classList.contains('open')? '-': '+';};
  const dots=document.createElement('div'); dots.className='status-dots';
  data[key].forEach(o=>{ const d=document.createElement('div'); d.className='dot'+(o.name?' filled':''); dots.appendChild(d); });
  const occ=document.createElement('div'); occ.className='occupants';
  data[key].forEach((o,i)=>{
    const div=document.createElement('div'); div.className='occupant';
    div.innerHTML=`
      <input type="text" placeholder="الإسم" value="${o.name}" oninput="updateField('${key}',${i},'name',this.value)">
      <input type="tel" placeholder="رقم الجوال" maxlength="10" value="${o.phone}" oninput="updateField('${key}',${i},'phone',this.value)">
      <select onchange="updateField('${key}',${i},'rank',this.value)">
        <option value="">الرتبة</option>
        ${ranks[floor].map(r=>`<option value="${r}"${o.rank===r?' selected':''}>${r}</option>`).join('')}
      </select>
      <select onchange="updateField('${key}',${i},'grade',this.value)">
        <option value="">المرتبة</option>
        ${Array.from({length:14},(_,j)=>`<option value="${j+1}"${o.grade===(j+1).toString()?' selected':''}>${j+1}</option>`).join('')}
      </select>
      <input type="text" placeholder="رقم اللوحة" value="${o.plate}" oninput="updateField('${key}',${i},'plate',this.value)">
    `;
    occ.appendChild(div);
  });
  card.append(title,btn,dots,occ);
  return card;
}

function updateField(key,index,field,value){
  data[key][index][field]=value; saveToStorage();
  document.querySelector(`#${key} .status-dots`).children[index].className = data[key][index].name? 'dot filled':'dot';
  const rm=key.replace('room-',''), fl=parseInt(rm.charAt(0));
  sendToGoogleSheet({sheet:'Guests',action:'update',floor:fl,room:rm,index,index,field, value});
}

function searchRooms(){
  const v=document.getElementById('search').value.trim();
  document.querySelectorAll('.room-card').forEach(card=>{
    const ok = data[card.id].some(o=>o.name.includes(v)||o.phone.includes(v)||o.rank.includes(v)||o.grade.toString()===v||o.plate.includes(v));
    card.style.display = ok? 'block':'none'; if(ok) card.classList.remove('open');
  });
}

function exportData(){
  const now=new Date(),date=now.toISOString().split('T')[0],w=window.open('','', 'width=800,height=600');
  let out=`تقرير | ${date}\n\n`;
  Object.keys(data).forEach(r=>{ if(data[r].some(o=>o.name)){
      out+=`غرفة ${r.replace('room-','')}\n`;
      data[r].forEach(o=>{ if(o.name) out+=`- ${o.name}, ${o.phone}, ${o.rank}, ${o.grade}, ${o.plate}\n`; });
      out+='\n';
    }
  });
  w.document.write(`<pre style="direction:rtl;font-family:Arial;font-weight:bold;white-space:pre-wrap;">${out}</pre>`);
}

</script>


</body>
</html>
