<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>مـبـنـى رابـطـة الـعـالـم الإسـلامـي</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #1e1e1e;
      color: white;
      margin: 0;
      padding: 20px;
    }
    h2 {
      text-align: center;
      font-size: 28px;
    }
    .floor-selection {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
      font-size: 18px;
    }
    .floor-btn {
      padding: 8px 16px;
      background-color: #444;
      border: none;
      color: white;
      cursor: pointer;
      border-radius: 5px;
    }
    .floor-btn:hover {
      background-color: #666;
    }
    #search {
      display: none;
      margin: 10px auto;
      padding: 5px 10px;
      width: 200px;
      text-align: center;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    #export-btn {
      display: block;
      margin: 10px auto;
      padding: 5px 10px;
      font-size: 14px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .cards-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    .room-card {
      background-color: #2c2c2c;
      border-radius: 8px;
      width: calc(25% - 10px);
      padding: 10px;
      box-sizing: border-box;
      transition: 0.3s ease;
      position: relative;
    }
    .room-card.open .occupants {
      display: block;
    }
    .room-title {
      font-weight: bold;
      margin-bottom: 5px;
      text-align: center;
    }
    .toggle-btn {
      position: absolute;
      top: 10px;
      left: 10px;
      background: none;
      color: white;
      border: none;
      font-size: 20px;
      cursor: pointer;
    }
    .occupants {
      display: none;
      margin-top: 10px;
    }
    .occupant {
      margin-bottom: 10px;
      background-color: #3b3b3b;
      padding: 5px;
      border-radius: 4px;
    }
    .occupant input,
    .occupant select {
      width: 100%;
      padding: 5px;
      background-color: #2c2c2c;
      border: 1px solid #555;
      color: white;
      text-align: center;
      box-sizing: border-box;
      margin-bottom: 5px;
    }
    .status-dots {
      display: flex;
      gap: 4px;
      justify-content: center;
      margin-bottom: 5px;
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: green;
    }
    .dot.filled {
      background-color: red;
    }
    @media (max-width: 768px) {
      .room-card {
        width: 100%;
      }
    }
  </style>
</head>
<body>

<h2>مـبـنـى رابـطـة الـعـالـم الإسـلامـي</h2>

<div class="floor-selection">
  <button class="floor-btn" onclick="loadFloor('all')">جميع الغرف</button>
  <button class="floor-btn" onclick="loadFloor(1)">الــطـــابــق الأول</button>
  <button class="floor-btn" onclick="loadFloor(2)">الـطـابـق الـثــانـي</button>
  <button class="floor-btn" onclick="loadFloor(3)">الـطـابـق الـثـالـث</button>
  <button class="floor-btn" onclick="loadFloor(4)">الـطــابــق الـرابـع</button>
</div>

<input type="text" id="search" placeholder="ابحث عن نزيل أو رقم أو رتبة أو لوحة" oninput="searchRooms()">
<button id="export-btn" onclick="exportData()">إصدار تقرير</button>

<div id="cards" class="cards-container"></div>

<script>
let currentFloor = 1;
const roomCounts = { 1: 36, 2: 36, 3: 12, 4: 12 };
const occupantsPerRoom = { 1: 3, 2: 3, 3: 8, 4: 8 };
const ranks = {
  1: ['ملازم', 'ملازم أول', 'نقيب', 'رائد', 'مقدم', 'عقيد', 'عميد', 'لواء'],
  2: ['جندي', 'جندي أول', 'عريف', 'وكيل رقيب', 'رقيب', 'رقيب أول', 'رئيس رقباء'],
  3: ['جندي', 'جندي أول', 'عريف', 'وكيل رقيب', 'رقيب'],
  4: ['جندي', 'جندي أول', 'عريف', 'وكيل رقيب', 'رقيب']
};
let data = JSON.parse(localStorage.getItem('housingData') || '{}');

function saveToStorage() {
  localStorage.setItem('housingData', JSON.stringify(data));
}

function loadFloor(floor) {
  currentFloor = floor;
  document.getElementById('search').style.display = floor === 'all' ? 'block' : 'none';
  const container = document.getElementById('cards');
  container.innerHTML = '';

  const floorsToShow = floor === 'all' ? [1, 2, 3, 4] : [floor];

  floorsToShow.forEach(f => {
    for (let i = 1; i <= roomCounts[f]; i++) {
      const roomNumber = `${f}${i.toString().padStart(2, '0')}`;
      const roomKey = `room-${roomNumber}`;
      if (!data[roomKey]) {
        data[roomKey] = Array.from({ length: occupantsPerRoom[f] }, () => ({ name: '', phone: '', rank: '', plate: '' }));
      }

      const card = document.createElement('div');
      card.className = 'room-card';
      card.id = roomKey;

      const title = document.createElement('div');
      title.className = 'room-title';
      title.textContent = `غـرفـة | ${roomNumber}`;

      const toggle = document.createElement('button');
      toggle.className = 'toggle-btn';
      toggle.innerHTML = '▼';
      toggle.onclick = () => {
        card.classList.toggle('open');
        toggle.innerHTML = card.classList.contains('open') ? '▲' : '▼';
      };

      const dots = document.createElement('div');
      dots.className = 'status-dots';
      data[roomKey].forEach(occ => {
        const dot = document.createElement('div');
        dot.className = 'dot' + (occ.name ? ' filled' : '');
        dots.appendChild(dot);
      });

      const occContainer = document.createElement('div');
      occContainer.className = 'occupants';

      data[roomKey].forEach((occ, idx) => {
        const occDiv = document.createElement('div');
        occDiv.className = 'occupant';
        occDiv.innerHTML = `
          <input type="text" placeholder="الاسم" value="${occ.name}" oninput="updateField('${roomKey}', ${idx}, 'name', this.value)">
          <input type="tel" placeholder="رقم التواصل" maxlength="10" value="${occ.phone}" oninput="updateField('${roomKey}', ${idx}, 'phone', this.value)">
          <select onchange="updateField('${roomKey}', ${idx}, 'rank', this.value)">
            <option value="">الرتبة</option>
            ${ranks[f].map(rank => `<option value="${rank}" ${occ.rank === rank ? 'selected' : ''}>${rank}</option>`).join('')}
          </select>
          <input type="text" placeholder="رقم اللوحة" value="${occ.plate}" oninput="updateField('${roomKey}', ${idx}, 'plate', this.value)">
        `;
        occContainer.appendChild(occDiv);
      });

      card.appendChild(title);
      card.appendChild(toggle);
      card.appendChild(dots);
      card.appendChild(occContainer);
      container.appendChild(card);
    }
  });

  saveToStorage();
}

function updateField(room, index, field, value) {
  data[room][index][field] = value;
  saveToStorage();
  const dotsContainer = document.querySelector(`#${room} .status-dots`);
  dotsContainer.children[index].className = data[room][index].name ? 'dot filled' : 'dot';
}

function searchRooms() {
  const val = document.getElementById('search').value.trim();
  const cards = document.querySelectorAll('.room-card');
  cards.forEach(card => {
    const roomData = data[card.id];
    const match = roomData.some(occ =>
      occ.name.includes(val) || occ.phone.includes(val) || occ.rank.includes(val) || occ.plate.includes(val)
    );
    card.style.display = match ? 'block' : 'none';
    if (match) card.classList.remove('open');
  });
}

function exportData() {
  let output = '';
  Object.keys(data).forEach(room => {
    const occupants = data[room].filter(occ => occ.name);
    if (occupants.length > 0) {
      output += `${room.replace('room-', 'غرفة | ')}:\n`;
      occupants.forEach((occ, i) => {
        output += ` ${i + 1}- الاسم: ${occ.name}, التواصل: ${occ.phone}, الرتبة: ${occ.rank}, اللوحة: ${occ.plate}\n`;
      });
      output += '\n';
    }
  });
  const newWindow = window.open('', '', 'width=800,height=600');
  newWindow.document.write(`<pre style="direction: rtl; font-family: Arial">${output}</pre>`);
}

loadFloor(1);

// Register Service Worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js').then(reg => {
    console.log('Service Worker Registered');
  }).catch(err => {
    console.error('SW registration failed:', err);
  });
}
</script>

</body>
</html>
