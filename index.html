<!DOCTYPE html>
<div class="background-logo"></div>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>مـبـنى رابـطـة الـعـالـم الإسـلامـي</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: white;
      color: white;
      margin: 0;
      padding: 20px;
      font-weight: bold;
    }
    .stats-title,
    .stats-number {
      color: white;
      position: relative; z-index: 1;
    }
    h2 {
      text-align: center;
      font-size: 35px !important;
      font-weight: bold !important;
      color: black !important;
    }
    /* نصوص الغرف داخل الكروت */
    .card .room-number,
    .card .guest-info {
      color: white;
      position: relative; z-index: 1;
    }
    h2,
    .floor-btn,
    #main-btn,
    .stat-box,
    .room-title,
    .toggle-btn,
    .occupant input,
    .occupant select,
    #search,
    #export-btn {
      font-weight: bold;
    }
    h2 { font-size: 28px; }
    .floor-selection {
      display: flex; justify-content: center; flex-wrap: wrap;
      gap: 10px; margin: 20px 0 15px; font-size: 18px;
      position: relative; z-index: 1;
    }
    .floor-btn {
      padding: 10px 18px; background-color: #2f2f2f;
      border: none; color: white; cursor: pointer;
      border-radius: 5px; font-size: 16px;
      position: relative; z-index: 1;
    }
    .floor-btn:hover {
      background-color: #3a3a3a;
    }
    #main-btn {
      font-size: 19px; padding: 12px 20px;
      background-color: #0b2545; color: white; opacity: 1;
      position: relative; z-index: 1;
    }
    #main-btn:hover {
      background-color: #133b5c;
    }
    body::before {
      content: "";
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background-image: url('https://raw.githubusercontent.com/abdulkhaleq404/housing-system/refs/heads/main/logopng2.png');
      background-repeat: no-repeat;
      background-position: center center;
      background-size: 600px auto;
      opacity: 0.25; z-index: -1; pointer-events: none;
    }
    #search {
      display: none; margin: 0 auto 10px;
      padding: 6px 10px; width: 200px;
      text-align: center; border-radius: 5px;
      border: 1px solid #444;
      background-color: #1e1e1e; color: white;
      position: relative; z-index: 1;
    }
    #export-btn {
      display: none; margin: 0 auto 20px;
      padding: 6px 12px; font-size: 14px;
      background-color: #0b2545; color: white;
      border: none; border-radius: 5px;
      cursor: pointer; opacity: 1;
      position: relative; z-index: 1;
    }
    #export-btn:hover {
      background-color: #133b5c;
    }
    .stats-container {
      display: grid; grid-template-columns: repeat(3, 1fr);
      gap: 15px; justify-items: center;
      margin-top: 40px; position: relative; z-index: 1;
    }
    .stat-box {
      background-color: #2c2c2c; border-radius: 8px;
      padding: 15px; width: 160px; text-align: center;
      font-size: 16px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      position: relative; z-index: 1;
    }
    .stat-number {
      font-size: 28px; margin: 10px 0 0;
      position: relative; z-index: 1;
    }
    .cards-container {
      display: flex; flex-wrap: wrap; gap: 10px;
      justify-content: center;
      position: relative; z-index: 1;
    }
    .room-card {
      background-color: #2c2c2c; border-radius: 8px;
      width: calc(25% - 10px); padding: 10px;
      box-sizing: border-box; transition: 0.3s ease;
      position: relative; z-index: 1;
    }
    .room-card.open .occupants {
      display: block; position: relative; z-index: 1;
    }
    .room-title {
      font-weight: bold; margin-bottom: 5px;
      text-align: center; position: relative; z-index: 1;
    }
    .toggle-btn {
      position: absolute; top: 10px; left: 10px;
      background: none; color: white; border: none;
      font-size: 20px; cursor: pointer;
      position: relative; z-index: 1;
    }
    .occupants {
      display: none; margin-top: 10px;
      position: relative; z-index: 1;
    }
    .occupant {
      margin-bottom: 10px; background-color: #333;
      padding: 5px; border-radius: 4px;
      position: relative; z-index: 1;
    }
    .occupant input,
    .occupant select {
      width: 100%; padding: 5px;
      background-color: #2f2f2f; border: 1px solid #555;
      color: white; text-align: center;
      box-sizing: border-box; margin-bottom: 5px;
      position: relative; z-index: 1;
    }
    .status-dots {
      display: flex; gap: 4px;
      justify-content: center; margin-bottom: 5px;
      position: relative; z-index: 1;
    }
    .dot {
      width: 10px; height: 10px; border-radius: 50%;
      background-color: green;
      position: relative; z-index: 1;
    }
    .dot.filled {
      background-color: red;
    }
    @media (max-width: 768px) {
      .room-card { width: 100%; }
      .stats-container { grid-template-columns: repeat(1,1fr); }
    }
  </style>
</head>
<body>
  <img src="https://raw.githubusercontent.com/abdulkhaleq404/housing-system/refs/heads/main/logopng2.png"
       alt="شعار"
       style="position: fixed; top: 10px; left: 10px;
              max-width: 200px; height: auto;
              opacity: 1; z-index: -1;
              pointer-events: none;">
  <h2>مـبـنى رابـطـة الـعـالـم الإسـلامـي</h2>

  <div class="floor-selection">
    <button id="main-btn" class="floor-btn" onclick="loadMain()">الـصـفـحـة الـرئـيـسـية</button>
  </div>

  <div class="floor-selection">
    <button class="floor-btn" onclick="loadFloor(1)">الــطـــابــق الأول</button>
    <button class="floor-btn" onclick="loadFloor(2)">الـطـابـق الـثــانـي</button>
    <button class="floor-btn" onclick="loadFloor(3)">الـطـابـق الـثـالـث</button>
    <button class="floor-btn" onclick="loadFloor(4)">الـطــابــق الـرابـع</button>
    <button class="floor-btn" onclick="loadFloor(0)">الـجـمـيـع</button>
  </div>

  <input type="text" id="search" placeholder="البحث" oninput="searchRooms()">
  <button id="export-btn" onclick="exportData()">إصـدار تـقـريـر</button>

  <div id="cards" class="cards-container"></div>

  <script>
    // ——— Google Sheets integration ———
    const SHEET_URL = 'https://script.google.com/macros/s/AKfycbwhXcN72pLqG-CdOXMKk3Z--_feGrJYoRX67m8qzzpDy5FBQAj0YnoPn_lT_lsZLwkp/exec';

    async function sendToGoogleSheet(payload) {
      try {
        const res = await fetch(SHEET_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        return await res.json();
      } catch (err) {
        console.error('Error sending to Google Sheets:', err);
      }
    }

    async function fetchGuests() {
      try {
        const res = await fetch(`${SHEET_URL}?action=getAll&sheet=Guests`);
        const guests = await res.json();
        guests.forEach(item => {
          const key = `room-${item.floor}${item.room}`;
          if (!data[key]) {
            data[key] = Array.from(
              { length: occupantsPerRoom[item.floor] },
              () => ({ name:'', phone:'', rank:'', grade:'', plate:'' })
            );
          }
          data[key].push({
            name: item.name,
            phone: item.phone,
            rank: item.rank || '',
            grade: item.grade || '',
            plate: item.plate || '',
            checkin_date: item.checkin_date,
            checkout_date: item.checkout_date,
            status: item.status
          });
        });
        saveToStorage();
        loadMain();
        loadFloor(currentFloor);
      } catch (err) {
        console.error('Error fetching Guests:', err);
      }
    }
    window.addEventListener('load', fetchGuests);

    // ——— بيانات التطبيق الأصلي ———
    let currentFloor = 1;
    const roomCounts       = { 1:36, 2:36, 3:12, 4:12 };
    const occupantsPerRoom = { 1:3,  2:3,  3:16, 4:16 };
    const ranks = {
      1: ['جندي','جندي أول','عريف','وكيل رقيب','رقيب','رقيب أول','رئيس رقباء','ملازم','ملازم أول','نقيب','رائد','مقدم','عقيد','عميد','لواء'],
      2: ['جندي','جندي أول','عريف','وكيل رقيب','رقيب','رقيب أول','رئيس رقباء','ملازم','ملازم أول','نقيب','رائد','مقدم','عقيد','عميد','لواء'],
      3: ['جندي','جندي أول','عريف','وكيل رقيب','رقيب','رقيب أول','رئيس رقباء','ملازم','ملازم أول','نقيب','رائد','مقدم','عقيد','عميد','لواء'],
      4: ['جندي','جندي أول','عريف','وكيل رقيب','رقيب','رقيب أول','رئيس رقباء','ملازم','ملازم أول','نقيب','رائد','مقدم','عقيد','عميد','لواء']
    };
    let data = JSON.parse(localStorage.getItem('housingData')||'{}');

    function saveToStorage() {
      localStorage.setItem('housingData', JSON.stringify(data));
    }

    function loadMain() {
      document.getElementById('cards').innerHTML = `
        <div class="stats-container">
          <div class="stat-box"><div>الطاقة الإستيعابية</div><div class="stat-number">600</div></div>
          <div class="stat-box"><div>الطاقة المتاحة</div><div class="stat-number">${600-countGuests()}</div></div>
          <div class="stat-box"><div>عدد الضيوف</div><div class="stat-number">${countGuests()}</div></div>
          <div class="stat-box"><div>الضباط</div><div class="stat-number">${countRanks('ضباط')}</div></div>
          <div class="stat-box"><div>الأفراد</div><div class="stat-number">${countRanks('أفراد')}</div></div>
          <div class="stat-box"><div>السيارات</div><div class="stat-number">${countCars()}</div></div>
        </div>`;
      document.getElementById('search').style.display='none';
      document.getElementById('export-btn').style.display='none';
    }

    function countGuests() {
      return Object.values(data).flat().filter(x=>x.name).length;
    }

    function countRanks(type) {
      const off = ranks[1];
      return Object.values(data).flat().filter(x=>{
        if(!x.rank) return false;
        return type==='ضباط'? off.includes(x.rank): !off.includes(x.rank);
      }).length;
    }

    function countCars() {
      return Object.values(data).flat().filter(x=>x.plate&&x.plate.trim()!=='').length;
    }

    function loadFloor(floor) {
      currentFloor = floor;
      document.getElementById('search').value='';
      const c = document.getElementById('cards');
      c.innerHTML='';
      if(floor===0) {
        document.getElementById('search').style.display='block';
        document.getElementById('export-btn').style.display='block';
        for(let f=1;f<=4;f++){
          for(let i=1;i<=roomCounts[f];i++){
            const num = `${f}${i.toString().padStart(2,'0')}`;
            const key = `room-${num}`;
            if(!data[key]){
              data[key]=Array.from({length:occupantsPerRoom[f]},()=>({name:'',phone:'',rank:'',grade:'',plate:''}));
            }
            c.appendChild(createRoomCard(key,num,f));
          }
        }
      } else {
        document.getElementById('search').style.display='none';
        document.getElementById('export-btn').style.display='none';
        for(let i=1;i<=roomCounts[floor];i++){
          const num = `${floor}${i.toString().padStart(2,'0')}`;
          const key = `room-${num}`;
          if(!data[key]){
            data[key]=Array.from({length:occupantsPerRoom[floor]},()=>({name:'',phone:'',rank:'',grade:'',plate:''}));
          }
          c.appendChild(createRoomCard(key,num,floor));
        }
      }
      saveToStorage();
    }

    function createRoomCard(roomKey,roomNumber,floor){
      const card=document.createElement('div');
      card.className='room-card';card.id=roomKey;
      const title=document.createElement('div');
      title.className='room-title';
      title.textContent=`غـرفـة | ${roomNumber}`;
      const toggle=document.createElement('button');
      toggle.className='toggle-btn';toggle.innerHTML='+';
      toggle.onclick=()=>{
        card.classList.toggle('open');
        toggle.innerHTML=card.classList.contains('open')?'-':'+';
      };
      const dots=document.createElement('div');dots.className='status-dots';
      data[roomKey].forEach(o=>{
        const d=document.createElement('div');
        d.className='dot'+(o.name?' filled':'');
        dots.appendChild(d);
      });
      const occC=document.createElement('div');occC.className='occupants';
      data[roomKey].forEach((o,idx)=>{
        const div=document.createElement('div');
        div.className='occupant';
        div.innerHTML=`
          <input type="text" placeholder="الإسم" value="${o.name}" oninput="updateField('${roomKey}',${idx},'name',this.value)">
          <input type="tel" placeholder="رقم الجوال" maxlength="10" value="${o.phone}" oninput="updateField('${roomKey}',${idx},'phone',this.value)">
          <select onchange="updateField('${roomKey}',${idx},'rank',this.value)"><option value="">الرتبة</option>${ranks[floor].map(r=>`<option value="${r}"${o.rank===r?' selected':''}>${r}</option>`).join('')}</select>
          <select onchange="updateField('${roomKey}',${idx},'grade',this.value)"><option value="">المرتبة</option>${Array.from({length:14},(_,i)=>`<option value="${i+1}"${o.grade===(i+1).toString()?' selected':''}>${i+1}</option>`).join('')}</select>
          <input type="text" placeholder="رقم اللوحة" value="${o.plate}" oninput="updateField('${roomKey}',${idx},'plate',this.value)">
        `;
        occC.appendChild(div);
      });
      card.appendChild(title);
      card.appendChild(toggle);
      card.appendChild(dots);
      card.appendChild(occC);
      return card;
    }

    function updateField(room,index,field,value){
      data[room][index][field]=value;
      saveToStorage();
      const dots=document.querySelector(`#${room} .status-dots`);
      dots.children[index].className=data[room][index].name?'dot filled':'dot';
      const rm = room.replace('room-','');
      const fl = parseInt(rm.charAt(0));
      sendToGoogleSheet({
        sheet:'Guests',
        action:'update',
        floor:fl,
        room:rm,
        index,
        field,
        value
      });
    }

    function searchRooms(){
      const v=document.getElementById('search').value.trim();
      document.querySelectorAll('.room-card').forEach(card=>{
        const arr=data[card.id];
        const ok=arr.some(o=>
          o.name.includes(v)||
          o.phone.includes(v)||
          o.rank.includes(v)||
          (o.grade&&o.grade.toString()===v)||
          o.plate.includes(v)
        );
        card.style.display=ok?'block':'none';
        if(ok) card.classList.remove('open');
      });
    }

    function exportData(){
      const n=new Date();
      const gd=n.toLocaleDateString('en-GB').split('/').reverse().join('/');
      const day=n.toLocaleDateString('ar-SA',{weekday:'long'});
      const h=n.getHours(), m=n.getMinutes().toString().padStart(2,'0');
      const p=h>=12?'PM':'AM', fh=h%12||12;
      let out=`تقرير مبنى رابطة العالم الإسلامي\nالتاريخ | ${gd}\nاليوم | ${day}\nالساعة | ${fh}:${m} ${p}\n\n`;
      Object.keys(data).forEach(r=>{
        if(data[r].some(o=>o.name)){
          out+=`• غرفة | ${r.replace('room-','')}\n`;
          data[r].forEach(o=>{
            if(o.name){
              out+=`الاسم: ${o.name}\nالرقم: ${o.phone}\nالرتبة: ${o.rank}\nالمرتبة: ${o.grade}\nاللوحة: ${o.plate}\n\n`;
            }
          });
        }
      });
      const w=window.open('','', 'width=800,height=600');
      w.document.write(`<pre style="direction:rtl;font-family:Arial;font-weight:bold;white-space:pre-wrap;">${out}</pre>`);
    }
  </script>
</body>
</html>
