<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>مبنى رابطة العالم الإسلامي</title>

  <!-- تضمين مكتبة Apps Script -->
  <script src="https://script.google.com/macros/library/d/1Uzl2zIpGz4jdbQddH_GIPKUdOhezQqilk3S9Y8RW-Wb2NQxvqVKZSsO-/2"></script>

  <style>
    body { font-family: Arial, sans-serif; background-color: white; color: white; margin:0; padding:20px; font-weight:bold; }
    h2 { text-align:center; font-size:35px; font-weight:bold; color:black; margin:10px 0; }
    .floor-selection { display:flex; justify-content:center; flex-wrap:wrap; gap:10px; margin:15px 0; }
    .floor-btn, #main-btn {
      padding:10px 18px; background-color:#2f2f2f; border:none; color:white;
      cursor:pointer; border-radius:5px; font-size:16px; font-weight:bold;
    }
    #main-btn { background-color:#0b2545; }
    #main-btn:hover, .floor-btn:hover { opacity:0.8; }

    #search {
      display:none; margin:10px auto; padding:6px 10px; width:200px;
      text-align:center; border-radius:5px; border:1px solid #444;
      background-color:#1e1e1e; color:white;
    }
    #export-btn {
      display:none; margin:10px auto; padding:6px 12px; background-color:#0b2545;
      color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold;
    }
    #export-btn:hover { opacity:0.8; }

    .stats-container {
      display:grid; grid-template-columns:repeat(3,1fr); gap:15px; margin:20px 0;
    }
    .stat-box { background-color:#2c2c2c; border-radius:8px; padding:15px; text-align:center; }
    .stat-number { font-size:28px; margin-top:5px; }

    .cards-container {
      display:flex; flex-wrap:wrap; gap:10px; justify-content:center;
    }
    .room-card {
      background-color:#2c2c2c; border-radius:8px;
      width:calc(25% - 10px); padding:10px; box-sizing:border-box; position:relative;
    }
    .room-title { text-align:center; font-weight:bold; margin-bottom:5px; color:white; }
    .toggle-btn {
      position:absolute; top:10px; left:10px; background:none; border:none;
      color:white; font-size:20px; cursor:pointer;
    }
    .status-dots { display:flex; gap:4px; justify-content:center; margin-bottom:5px; }
    .dot { width:10px; height:10px; border-radius:50%; background-color:green; }
    .dot.filled { background-color:red; }

    .occupants { display:none; margin-top:10px; }
    .room-card.open .occupants { display:block; } /* show occupants on open */
    .occupant {
      background-color:#333; padding:5px; border-radius:4px; margin-bottom:10px;
    }
    .occupant input, .occupant select {
      width:100%; padding:5px; margin-bottom:5px;
      background-color:#2f2f2f; border:1px solid #555; color:white; text-align:center;
      box-sizing:border-box;
    }

    @media(max-width:768px){
      .room-card{width:100%;}
      .stats-container{grid-template-columns:1fr;}
    }

    body::before {
      content:""; position:fixed; top:0; left:0; width:100%; height:100%;
      background:url('https://raw.githubusercontent.com/abdulkhaleq404/housing-system/refs/heads/main/logopng2.png')
                 center/600px auto no-repeat; opacity:0.2; z-index:-1; pointer-events:none;
    }
  </style>
</head>
<body>
  <div style="position:fixed; top:10px; left:10px; z-index:999;">
    <img src="https://raw.githubusercontent.com/abdulkhaleq404/housing-system/refs/heads/main/logopng2.png"
         alt="شعار" style="max-width:200px; height:auto;">
  </div>

  <h2>مبنى رابطة العالم الإسلامي</h2>

  <div class="floor-selection">
    <button id="main-btn" class="floor-btn" onclick="loadMain()">الرئيسية</button>
    <button id="save-btn" class="floor-btn" style="margin-left:8px;padding:6px 10px;font-size:14px;" onclick="saveAll()">حفظ</button>
  </div>

  <div class="floor-selection">
    <button class="floor-btn" onclick="loadFloor(1)">الطابق 1</button>
    <button class="floor-btn" onclick="loadFloor(2)">الطابق 2</button>
    <button class="floor-btn" onclick="loadFloor(3)">الطابق 3</button>
    <button class="floor-btn" onclick="loadFloor(4)">الطابق 4</button>
    <button class="floor-btn" onclick="loadFloor(0)">الجميع</button>
  </div>

  <input type="text" id="search" placeholder="بحث..." oninput="searchRooms()">
  <button id="export-btn" class="floor-btn" onclick="exportData()">تصدير تقرير</button>
  <div id="cards" class="cards-container"></div>

  <script>
    const SHEET_URL = 'https://script.google.com/macros/s/AKfycbxignaqrgpUE7SuQ0yGRopxCPwZDLAfCtaaguWCS37_poowA5J4vOURP9cbSJ2cMuVj/exec';

    let currentFloor = 1;
    const roomCounts = {1:36,2:36,3:12,4:12};
    const occupantsPerRoom = {1:3,2:3,3:16,4:16};
    const ranks = {
      1:['جندي','جندي أول','عريف','وكيل رقيب','رقيب','ملازم','ملازم أول','نقيب','رائد','مقدم','عقيد','عميد','لواء'],
      2:['جندي','جندي أول','عريف','وكيل رقيب','رقيب','ملازم','ملازم أول','نقيب','رائد','مقدم','عقيد','عميد','لواء'],
      3:['جندي','جندي أول','عريف','وكيل رقيب','رقيب','ملازم','ملازم أول','نقيب','رائد','مقدم','عقيد','عميد','لواء'],
      4:['جندي','جندي أول','عريف','وكيل رقيب','رقيب','ملازم','ملازم أول','نقيب','رائد','مقدم','عقيد','عميد','لواء']
    };
    let data = JSON.parse(localStorage.getItem('housingData') || '{}');
    let initialCounts = {};

    async function fetchGuests() {
      try {
        const res = await fetch(`${SHEET_URL}?action=getAll&sheet=Guests`);
        const guests = await res.json();
        data = {};
        guests.forEach(item => {
          const key = `room-${item.floor}${item.room}`;
          if (!data[key]) data[key] = [];
          data[key].push({ ...item });
        });
        Object.keys(data).forEach(key => {
          initialCounts[key] = data[key].length;
          const f = parseInt(key.charAt(5));
          while (data[key].length < occupantsPerRoom[f]) {
            data[key].push({ name:'', phone:'', rank:'', grade:'', plate:'' });
          }
        });
        saveToStorage();
        loadMain();
      } catch(e) { console.error(e); }
    }
    window.addEventListener('load', fetchGuests);
    window.addEventListener('focus', fetchGuests);

    function saveToStorage() {
      localStorage.setItem('housingData', JSON.stringify(data));
    }

    function sendToGoogleSheet(payload) {
      return fetch(SHEET_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      }).then(r=>r.json()).catch(e=>console.error('Error:', e));
    }

    function saveAll() {
      Object.keys(data).forEach(key => {
        const parts = key.split('-')[1], f = parseInt(parts.charAt(0));
        const recs = data[key];
        for (let i = initialCounts[key] || 0; i < recs.length; i++) {
          const r = recs[i];
          if (r.name || r.phone) {
            sendToGoogleSheet({
              sheet:'Guests', action:'add',
              floor:f, room:parts,
              name:r.name, info:'', phone:r.phone,
              checkin_date:r.checkin_date||new Date().toISOString().split('T')[0],
              checkout_date:r.checkout_date||'', status:r.status||''
            }).then(res=>{ if(res.success) initialCounts[key]++; });
          }
        }
      });
      alert('تم حفظ البيانات الجديدة في Google Sheets');
    }

    function loadMain() {
      const cards = document.getElementById('cards');
      cards.innerHTML = `<div class="stats-container">
        <div class="stat-box"><div>الطاقة الإجمالية</div><div class="stat-number">600</div></div>
        <div class="stat-box"><div>المتاحة</div><div class="stat-number">${600-countGuests()}</div></div>
        <div class="stat-box"><div>الضيوف</div><div class="stat-number">${countGuests()}</div></div>
        <div class="stat-box"><div>ضباط</div><div class="stat-number">${countRanks('ضباط')}</div></div>
        <div class="stat-box"><div>أفراد</div><div class="stat-number">${countRanks('أفراد')}</div></div>
        <div class="stat-box"><div>سيارات</div><div class="stat-number">${countCars()}</div></div>
      </div>`;
      document.getElementById('search').style.display='none';
      document.getElementById('export-btn').style.display='none';
    }

    function countGuests() { return Object.values(data).flat().filter(o=>o.name).length; }
    function countRanks(type) {
      const off = ranks[1];
      return Object.values(data).flat().filter(o=>o.rank)
        .filter(o=> type==='ضباط'? off.includes(o.rank): !off.includes(o.rank)).length;
    }
    function countCars() { return Object.values(data).flat().filter(o=>o.plate).length; }

    function loadFloor(floor) {
      currentFloor = floor;
      document.getElementById('cards').innerHTML = '';
      if (floor === 0) {
        document.getElementById('search').style.display='block';
        document.getElementById('export-btn').style.display='block';
        [1,2,3,4].forEach(f => renderFloor(f));
      } else {
        document.getElementById('search').style.display='none';
        document.getElementById('export-btn').style.display='none';
        renderFloor(floor);
      }
      saveToStorage();
    }

    function renderFloor(f) {
      const container = document.getElementById('cards');
      for (let i = 1; i <= roomCounts[f]; i++) {
        const num = `${f}${String(i).padStart(2,'0')}`, key = `room-${num}`;
        if (!data[key]) {
          data[key] = Array.from({ length: occupantsPerRoom[f] }, () => ({ name:'', phone:'', rank:'', grade:'', plate:'' }));
          initialCounts[key] = 0;
        }
        container.appendChild(createRoomCard(key, num, f));
      }
    }

    function createRoomCard(roomKey, roomNumber, floor) {
      const card = document.createElement('div'); card.className='room-card'; card.id=roomKey;
      const title = document.createElement('div'); title.className='room-title'; title.textContent=`غرفة ${roomNumber}`;
      const btn = document.createElement('button'); btn.className='toggle-btn'; btn.textContent='+';
      btn.onclick = () => { card.classList.toggle('open'); btn.textContent = card.classList.contains('open')?'-':'+'; };
      const dots = document.createElement('div'); dots.className='status-dots';
      data[roomKey].forEach(o => { const d=document.createElement('div'); d.className='dot'+(o.name?' filled':''); dots.appendChild(d); });
      const occs = document.createElement('div'); occs.className='occupants';
      data[roomKey].forEach((o,idx) => {
        const div=document.createElement('div'); div.className='occupant';
        div.innerHTML = `
          <input type="text" placeholder="الإسم" value="${o.name}" oninput="handleField('${roomKey}',${idx},'name',this.value)">
          <input type="tel" placeholder="رقم الجوال" maxlength="10" value="${o.phone}" oninput="handleField('${roomKey}',${idx},'phone',this.value)">
          <select onchange="handleField('${roomKey}',${idx},'rank',this.value)"><option value="">الرتبة</option>${ranks[floor].map(r=>`<option value="${r}"${o.rank===r?' selected':''}>${r}</option>`).join('')}</select>
          <select onchange="handleField('${roomKey}',${idx},'grade',this.value)"><option value="">المرتبة</option>${Array.from({length:14},(_,j)=>`<option value="${j+1}"${o.grade===(j+1).toString()?' selected':''}>${j+1}</option>`).join('')}</select>
          <input type="text" placeholder="رقم اللوحة" value="${o.plate}" oninput="handleField('${roomKey}',${idx},'plate',this.value)">
        `;
        occs.appendChild(div);
      });
      card.append(title, btn, dots, occs);
      return card;
    }

    function handleField(room, idx, field, value) {
      const wasBlank = (initialCounts[room]||0) <= idx;
      data[room][idx][field] = value;
      saveToStorage();
      document.querySelector(`#${room} .status-dots`).children[idx].className = data[room][idx].name?'dot filled':'dot';
      const parts = room.split('-')[1], f = parseInt(parts.charAt(0));
      if (wasBlank && (field==='name'||field==='phone')) {
        const rec = data[room][idx];
        sendToGoogleSheet({ sheet:'Guests', action:'add', floor:f, room:parts, name:rec.name, info:'', phone:rec.phone, checkin_date:rec.checkin_date||new Date().toISOString().split('T')[0], checkout_date:'', status:'checked-in' }).then(r=>{ if(r.success) initialCounts[room]++; });
      } else {
        sendToGoogleSheet({ sheet:'Guests', action:'update', floor:f, room:parts, index:idx, field, value });
      }
    }

    function searchRooms() {
      const v=document.getElementById('search').value.trim();
      document.querySelectorAll('.room-card').forEach(c=>{ const ok=data[c.id].some(o=>o.name.includes(v)||o.phone.includes(v)||o.rank.includes(v)||(o.grade&&o.grade.toString()===v)||o.plate.includes(v)); c.style.display=ok?'block':'none'; if(ok) c.classList.remove('open'); });
    }

    function exportData() { /* ... */ }

    loadMain();
  </script>
</body>
</html>
